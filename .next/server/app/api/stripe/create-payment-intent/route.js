(()=>{var e={};e.id=5798,e.ids=[5798],e.modules={47495:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=47495,e.exports=t},20399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{"use strict";e.exports=require("buffer")},61282:e=>{"use strict";e.exports=require("child_process")},84770:e=>{"use strict";e.exports=require("crypto")},17702:e=>{"use strict";e.exports=require("events")},32615:e=>{"use strict";e.exports=require("http")},35240:e=>{"use strict";e.exports=require("https")},98216:e=>{"use strict";e.exports=require("net")},68621:e=>{"use strict";e.exports=require("punycode")},76162:e=>{"use strict";e.exports=require("stream")},82452:e=>{"use strict";e.exports=require("tls")},17360:e=>{"use strict";e.exports=require("url")},21764:e=>{"use strict";e.exports=require("util")},71568:e=>{"use strict";e.exports=require("zlib")},58359:()=>{},93739:()=>{},80034:(e,t,r)=>{"use strict";r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>f,requestAsyncStorage:()=>l,routeModule:()=>d,serverHooks:()=>_,staticGenerationAsyncStorage:()=>m});var i={};r.r(i),r.d(i,{POST:()=>c});var s=r(49303),n=r(88716),o=r(60670),a=r(87070),u=r(69206);let p=(0,r(67721).createBrowserClient)("https://uolpvxgcobjefivqnscj.supabase.co","sb_publishable_XfZivZLXatSeakd_ccimng_ZiTnn0dN");async function c(e){try{let{riderId:t,merchantId:r,startTime:i,endTime:s,hours:n,riderAmount:o}=await e.json();if(!t||!r||!i||!s||!n||!o)return a.NextResponse.json({error:"All booking details are required, including riderAmount"},{status:400});let c=.15*o,d=o+c,{data:l,error:m}=await p.from("riders_details").select("stripe_account_id, stripe_onboarding_complete").eq("profile_id",t).single();if(m||!l)return a.NextResponse.json({error:"Rider not found"},{status:404});if(!l.stripe_account_id||!l.stripe_onboarding_complete)return a.NextResponse.json({error:"Rider has not completed Stripe onboarding"},{status:400});let _=await u.Ag.paymentIntents.create({amount:Math.round(100*d),currency:"eur",application_fee_amount:Math.round(100*c),transfer_data:{destination:l.stripe_account_id},metadata:{riderId:t,merchantId:r,startTime:i,endTime:s,hours:n.toString(),riderAmount:o.toString(),platformFee:c.toString(),totalAmount:d.toString()}}),{error:x}=await p.from("bookings").insert({rider_id:t,merchant_id:r,start_time:i,end_time:s,rider_amount:o,platform_fee:c,total_amount:d,stripe_payment_intent_id:_.id,status:"confermata"});if(x)return a.NextResponse.json({error:"Failed to create booking record"},{status:500});return a.NextResponse.json({clientSecret:_.client_secret,paymentIntentId:_.id})}catch(e){return console.error("Error creating payment intent:",e),a.NextResponse.json({error:"Failed to create payment intent"},{status:500})}}let d=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/stripe/create-payment-intent/route",pathname:"/api/stripe/create-payment-intent",filename:"route",bundlePath:"app/api/stripe/create-payment-intent/route"},resolvedPagePath:"/home/dimagio/Applications/bemyrider project/bemyrider_app/bemyrider/app/api/stripe/create-payment-intent/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:l,staticGenerationAsyncStorage:m,serverHooks:_}=d,x="/api/stripe/create-payment-intent/route";function f(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:m})}},69206:(e,t,r)=>{"use strict";r.d(t,{Ag:()=>i});let i=new(r(48472)).Z(process.env.STRIPE_SECRET_KEY,{apiVersion:"2023-10-16"})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[9276,5972,785,7721,8472],()=>r(80034));module.exports=i})();